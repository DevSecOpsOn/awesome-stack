include:
  - local: '.gitlab-ci/security-scan.yml'
  - local: '.gitlab-ci/validate-stacks.yml'
  - local: '.gitlab-ci/deploy-swarm.yml'
  - local: '.gitlab-ci/notifications.yml'
  - local: '.gitlab-ci/cleanup.yml'

stages:
  - security
  - validate
  - deploy
  - notify
  - cleanup

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# Main pipeline orchestration
docker-swarm-pipeline:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - echo "Docker Swarm deployment pipeline initiated"
    - echo "MR Number: $CI_MERGE_REQUEST_IID"
    - echo "Source Branch: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    - echo "Target Branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
  needs:
    - job: security-scan
    - job: validate-stacks

cleanup_subbranches:
  stage: cleanup
  only:
    - master
  script:
    - echo "Git setting"
    - git remote remove origin
    - git remote add origin https://$GITLAB_USERNAME:$GITLAB_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
    - echo "Fetching all remote branches..."
    - git fetch --prune
    - echo "Listing and deleting all subbranches..."
    - |
      branches=$(git branch -r | grep -v 'origin/HEAD' | grep -v 'origin/master' | sed 's/origin\///')
      for branch in $branches; do
        echo "Deleting branch $branch"
        git push origin --delete $branch || echo "Failed to delete $branch"
      done
