# Security Scanning Pipeline
kind: pipeline
type: docker
name: security-scanning

platform:
  os: linux
  arch: arm64

environment:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

steps:

  - name: security-scan-trivy
    image: aquasec/trivy:latest
    privileged: true
    failure: ignore
    commands:
      - echo "Starting security scan with Trivy..."
      - trivy --version
      - |
        # Scan all YAML files for misconfigurations
        find . -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "Scanning $file..."
          trivy config --severity HIGH,CRITICAL --exit-code 1 "$file" || exit 1
        done
      - echo " Trivy security scan completed"

  - name: security-scan-hadolint
    image: hadolint/hadolint:latest-alpine
    privileged: true
    commands:
      - echo "Starting Dockerfile linting with Hadolint..."
      - |
        # Find and scan all Dockerfiles
        find . -name "Dockerfile*" | while read dockerfile; do
          echo "Linting $dockerfile..."
          hadolint "$dockerfile" || exit 1
        done
      - echo " Hadolint scan completed"
    when:
      status: [success]

---

# Validation Pipeline
kind: pipeline
type: docker
name: validation

platform:
  os: linux
  arch: arm64

environment:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

steps:
  - name: compose-validation
    image: docker/compose:latest
    privileged: true
    failure: ignore
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "Validating Docker Compose files..."
      - |
        find . -name "*.yaml" -o -name "*.yml" | while read file; do
          if grep -q "version:" "$file" && grep -q "services:" "$file"; then
            echo "Validating compose file: $file"
            docker-compose -f "$file" config --quiet || exit 1
          fi
        done
      - echo "Docker Compose validation completed"
    when:
      status: [success]

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock

depends_on:
  - security-scanning

---

# Notification Pipeline
kind: pipeline
type: docker
name: notification

platform:
  os: linux
  arch: arm64

steps:
  - name: slack-notification
    image: plugins/slack
    privileged: true
    failure: ignore
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: "#deployments"
      username: "Drone CI"
      icon_emoji: ":rocket:"
      template: |
        {{#success build.status}}
        *Docker Stacks Pipeline - SUCCESS*

        *Build Details:*
        Repository: {{repo.name}}
        Branch: {{build.branch}}
        Commit: {{build.commit}}
        Author: {{build.author}}
        Build: #{{build.number}}

        *Deployment Status:*
        Security Scan: Ã¢Å“â€¦ Passed
        Validation: Ã¢Å“â€¦ Passed
        Testing: Ã¢Å“â€¦ Passed
        Production Deploy: Ã¢Å“â€¦ Completed

        *Links:*
        Build: {{build.link}}
        Commit: {{build.link}}/commit/{{build.commit}}

        Duration: {{since build.started}}
        {{else}}
        *Docker Stacks Pipeline - FAILED*

        *Build Details:*
        Repository: {{repo.name}}
        Branch: {{build.branch}}
        Commit: {{build.commit}}
        Author: {{build.author}}
        Build: #{{build.number}}

        *Failed Step:* {{build.status}}

        *Links:*
        Build: {{build.link}}
        Commit: {{build.link}}/commit/{{build.commit}}

        Duration: {{since build.started}}
        {{/success}}
    when:
      status: [success, failure]

depends_on:
  - validation

---

# Vault Management Pipeline
kind: pipeline
type: docker
name: vault

platform:
  os: linux
  arch: arm64

environment:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

steps:

  - name: vault-monitoring-setup
    image: hashicorp/vault:latest
    privileged: true
    failure: ignore
    environment:
      VAULT_ADDR: "http://vault_server:8200"
      VAULT_SKIP_VERIFY: "true"
      VAULT_ROOT_TOKEN:
        from_secret: VAULT_ROOT_TOKEN
    commands:
      - echo "ğŸ“Š Setting up Vault monitoring..."
      - |
        # Decode root token
        echo "$VAULT_ROOT_TOKEN" | base64 -d > /tmp/root_token
        export VAULT_TOKEN=$(cat /tmp/root_token)
        rm -f /tmp/root_token

        # Enable audit logging if not already enabled
        echo "ğŸ“ Configuring audit logging..."
        vault audit enable -path="file" file file_path=/vault/logs/audit.log || echo "âš ï¸ Audit logging may already be enabled"

        # Check metrics endpoint
        echo "ğŸ“ˆ Testing metrics endpoint..."
        curl -s -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/sys/metrics?format=prometheus" > /dev/null && echo "âœ… Metrics endpoint accessible" || echo "âš ï¸ Metrics endpoint not accessible"

        # Show current status
        echo "ğŸ“Š Current Vault status:"
        vault status

        echo "âœ… Vault monitoring setup completed"
    when:
      status: [success]

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock

depends_on:
  - notification

---
# Vault Notification Pipeline
kind: pipeline
type: docker
name: vault-notification

platform:
  os: linux
  arch: arm64

steps:
  - name: vault-slack-notification
    image: plugins/slack
    privileged: true
    failure: ignore
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: "#vault-ops"
      username: "Vault CI"
      icon_emoji: ":lock:"
      template: |
        {{#success build.status}}
        ğŸ”“ *Vault Management Pipeline - SUCCESS*

        ğŸ” *Vault Operations Completed:*
        â€¢ Health Check: âœ… Passed
        â€¢ Auto-Unseal: âœ… Completed
        â€¢ Authentication Test: âœ… Passed
        â€¢ Configuration Backup: âœ… Created
        â€¢ Monitoring Setup: âœ… Configured

        ğŸ“‹ *Build Details:*
        â€¢ Repository: {{repo.name}}
        â€¢ Branch: {{build.branch}}
        â€¢ Build: #{{build.number}}
        â€¢ Author: {{build.author}}

        ğŸ”— *Links:*
        â€¢ Build: {{build.link}}
        â€¢ Commit: {{build.link}}/commit/{{build.commit}}

        ğŸ• Duration: {{since build.started}}
        {{else}}
        ğŸ”’ *Vault Management Pipeline - FAILED*

        âŒ *Failed Operations:*
        â€¢ Status: {{build.status}}
        â€¢ Step: Check build logs for details

        ğŸ“‹ *Build Details:*
        â€¢ Repository: {{repo.name}}
        â€¢ Branch: {{build.branch}}
        â€¢ Build: #{{build.number}}
        â€¢ Author: {{build.author}}

        ğŸ”— *Links:*
        â€¢ Build: {{build.link}}
        â€¢ Commit: {{build.link}}/commit/{{build.commit}}

        ğŸ• Duration: {{since build.started}}

        âš ï¸ *Action Required:* Manual Vault intervention may be needed
        {{/success}}
    when:
      status: [success, failure]
