name: Deploy Docker Swarm

on:
  workflow_call:
    inputs:
      stack_type:
        description: 'Stack type to deploy'
        required: true
        type: string
        default: 'devsecops'
    outputs:
      swarm-status:
        description: "Docker Swarm setup status"
        value: ${{ jobs.setup-swarm.outputs.swarm-status }}
      deployment-results:
        description: "Deployment results summary"
        value: ${{ jobs.deploy-stacks.outputs.deployment-results }}

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  setup-swarm:
    name: Setup Docker Swarm
    runs-on: ubuntu-latest
    outputs:
      swarm-status: ${{ steps.swarm-setup.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize Docker Swarm
        id: swarm-setup
        run: |
          echo "ðŸ³ Initializing Docker Swarm..."
          
          # Initialize swarm if not already initialized
          if ! docker info | grep -q "Swarm: active"; then
            docker swarm init --advertise-addr 127.0.0.1
            echo "âœ… Docker Swarm initialized"
          else
            echo "âœ… Docker Swarm already active"
          fi
          
          # Create overlay network
          if ! docker network ls | grep -q "docker2docker"; then
            docker network create --driver=overlay --attachable docker2docker
            echo "âœ… Created docker2docker network"
          else
            echo "âœ… docker2docker network already exists"
          fi
          
          # Create secrets (using dummy values for CI)
          echo "dummy-db-password" | docker secret create DOCKER_SECRET_DB - 2>/dev/null || echo "âœ… DOCKER_SECRET_DB secret exists"
          echo "dummy-slack-hook" | docker secret create SLACK_ALERTS_HOOK - 2>/dev/null || echo "âœ… SLACK_ALERTS_HOOK secret exists"
          
          echo "status=Docker Swarm setup completed" >> $GITHUB_OUTPUT

  deploy-stacks:
    name: Deploy Docker Stacks
    runs-on: ubuntu-latest
    needs: setup-swarm
    outputs:
      deployment-results: ${{ steps.deploy-summary.outputs.results }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy base stacks
        run: |
          echo "ðŸš€ Deploying base stacks..."
          
          # Base stacks from Makefile
          BASE_STACKS="traefik db ngrok droneci"
          
          for stack in $BASE_STACKS; do
            if [ -d "$stack" ]; then
              stack_file=$(find "$stack" -maxdepth 1 -name "*.yml" -o -name "*.yaml" | head -n 1)
              if [ -n "$stack_file" ]; then
                echo "Deploying $stack using $stack_file..."
                docker stack deploy -c "$stack_file" "$stack"
                echo "âœ… Stack $stack deployed"
                sleep 3  # Brief pause between deployments
              else
                echo "âš ï¸  No stack file found for $stack"
              fi
            else
              echo "âš ï¸  Directory $stack not found"
            fi
          done

      - name: Deploy DevOps stacks
        if: inputs.stack_type == 'devops' || inputs.stack_type == 'devsecops'
        run: |
          echo "ðŸš€ Deploying DevOps stacks..."
          
          # DevOps stacks from Makefile
          DEVOPS_STACKS="redis atuin gitea harness gogs runatlantis homarr portainer beszel prometheus grafana fluentbit jaeger otelcol consul localstack watchtower minio"
          
          for stack in $DEVOPS_STACKS; do
            if [ -d "$stack" ]; then
              stack_file=$(find "$stack" -maxdepth 1 -name "*.yml" -o -name "*.yaml" | head -n 1)
              if [ -n "$stack_file" ]; then
                echo "Deploying $stack using $stack_file..."
                docker stack deploy -c "$stack_file" "$stack"
                echo "âœ… Stack $stack deployed"
                sleep 3  # Brief pause between deployments
              else
                echo "âš ï¸  No stack file found for $stack"
              fi
            else
              echo "â„¹ï¸  Directory $stack not found (optional stack)"
            fi
          done

      - name: Deploy Security stacks
        if: inputs.stack_type == 'devsecops'
        run: |
          echo "ðŸ” Deploying Security stacks..."
          
          # Security stacks from Makefile
          SECURITY_STACKS="vault passbolt"
          
          for stack in $SECURITY_STACKS; do
            if [ -d "$stack" ]; then
              stack_file=$(find "$stack" -maxdepth 1 -name "*.yml" -o -name "*.yaml" | head -n 1)
              if [ -n "$stack_file" ]; then
                echo "Deploying $stack using $stack_file..."
                docker stack deploy -c "$stack_file" "$stack"
                echo "âœ… Stack $stack deployed"
                sleep 5  # Longer pause for security services
              else
                echo "âš ï¸  No stack file found for $stack"
              fi
            else
              echo "â„¹ï¸  Directory $stack not found (optional stack)"
            fi
          done

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
          echo "ðŸ“Š Current stack status:"
          docker stack ls
          echo ""
          echo "ðŸ“‹ Service status:"
          docker service ls
          echo ""
          echo "ðŸ³ Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Health check deployed services
        run: |
          echo "ðŸ¥ Performing health checks..."
          
          # Check if Traefik is responding
          timeout 30 bash -c 'until curl -f http://localhost:80 2>/dev/null; do sleep 2; done' && echo "âœ… Traefik is responding" || echo "âš ï¸  Traefik health check failed"
          
          # Check Docker services
          failed_services=$(docker service ls --filter "desired-state=running" --format "{{.Name}} {{.Replicas}}" | grep "0/" | wc -l)
          if [ "$failed_services" -eq 0 ]; then
            echo "âœ… All services are running"
          else
            echo "âš ï¸  Some services failed to start:"
            docker service ls --filter "desired-state=running" --format "{{.Name}} {{.Replicas}}" | grep "0/" || echo "No failed services found"
          fi
          
          # Additional health checks for key services
          echo "ðŸ” Checking key service health..."
          docker service ls --format "{{.Name}} {{.Replicas}}" | grep -E "(traefik|db)" || echo "Core services not found"

      - name: Deployment summary
        id: deploy-summary
        run: |
          total_stacks=$(docker stack ls --format "{{.Name}}" | wc -l)
          total_services=$(docker service ls --format "{{.Name}}" | wc -l)
          running_services=$(docker service ls --filter "desired-state=running" --format "{{.Name}} {{.Replicas}}" | grep -v "0/" | wc -l || echo "0")
          
          echo "results=Deployed $total_stacks stacks with $running_services/$total_services services running" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Deployment Summary:"
          echo "   â€¢ Stack type: ${{ inputs.stack_type }}"
          echo "   â€¢ Total stacks: $total_stacks"
          echo "   â€¢ Total services: $total_services"
          echo "   â€¢ Running services: $running_services"
