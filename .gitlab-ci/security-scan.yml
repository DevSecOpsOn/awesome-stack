# Security scanning pipeline
security-scan:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Starting security scan"
    - echo "Scanning for configuration vulnerabilities with Trivy"
    
    # Install Trivy
    - |
      curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    
    # Scan all YAML files for misconfigurations
    - |
      echo "Scanning YAML files for misconfigurations"
      find . -name "*.yaml" -o -name "*.yml" | while read file; do
        echo "Scanning $file"
        trivy config --severity HIGH,CRITICAL --exit-code 1 "$file" || exit 1
      done
    
    # Scan for secrets in the repository
    - |
      echo "Scanning for secrets and sensitive data"
      trivy fs --scanners secret --severity HIGH,CRITICAL --exit-code 1 . || exit 1
    
    - echo "Security scan completed successfully"
  artifacts:
    reports:
      junit: trivy-report.xml
    paths:
      - trivy-report.xml
    expire_in: 1 week
  allow_failure: false

# Secret detection with GitLeaks
secret-detection:
  stage: security
  image: zricethezav/gitleaks:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - echo "Scanning for leaked credentials"
    - gitleaks detect --source . --verbose --exit-code 1
    - echo "No secrets detected"
  allow_failure: false

# Dockerfile linting
dockerfile-lint:
  stage: security
  image: hadolint/hadolint:latest-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - echo "Linting Dockerfiles"
    - |
      find . -name "Dockerfile*" | while read dockerfile; do
        echo "Linting $dockerfile"
        hadolint "$dockerfile" || exit 1
      done
    - echo "Dockerfile linting completed"
  allow_failure: true
