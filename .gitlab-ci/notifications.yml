# Notification pipeline
slack-notification-success:
  stage: notify
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - job: health-check
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Sending success notification to Slack"
    
    # Load deployment summary
    - source deployment-summary.env
    
    # Prepare Slack message
    - |
      SLACK_MESSAGE=$(cat <<EOF
      {
        "channel": "#commits",
        "username": "GitLab CI",
        "icon_emoji": ":rocket:",
        "attachments": [
          {
            "color": "good",
            "title": "Docker Swarm Deployment - SUCCESS",
            "fields": [
              {
                "title": "Project",
                "value": "$CI_PROJECT_NAME",
                "short": true
              },
              {
                "title": "Branch",
                "value": "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME",
                "short": true
              },
              {
                "title": "Merge Request",
                "value": "<$CI_MERGE_REQUEST_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID|MR !$CI_MERGE_REQUEST_IID>",
                "short": true
              },
              {
                "title": "Author",
                "value": "$GITLAB_USER_NAME",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|$CI_COMMIT_SHORT_SHA>",
                "short": true
              },
              {
                "title": "Pipeline",
                "value": "<$CI_PIPELINE_URL|#$CI_PIPELINE_ID>",
                "short": true
              },
              {
                "title": "Deployment Results",
                "value": "Stacks: $TOTAL_STACKS | Services: $RUNNING_SERVICES/$TOTAL_SERVICES running",
                "short": false
              }
            ],
            "footer": "GitLab CI/CD",
            "ts": $(date +%s)
          }
        ]
      }
      EOF
      )
    
    # Send to Slack
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
          --data "$SLACK_MESSAGE" \
          "$SLACK_WEBHOOK_URL"
        echo "Success notification sent to Slack"
      else
        echo "SLACK_WEBHOOK_URL not configured, skipping notification"
      fi
  when: on_success

slack-notification-failure:
  stage: notify
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_failure
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Sending failure notification to Slack"
    
    # Prepare Slack message for failure
    - |
      SLACK_MESSAGE=$(cat <<EOF
      {
        "channel": "#commits",
        "username": "GitLab CI",
        "icon_emoji": ":warning:",
        "attachments": [
          {
            "color": "danger",
            "title": "Docker Swarm Deployment - FAILED",
            "fields": [
              {
                "title": "Project",
                "value": "$CI_PROJECT_NAME",
                "short": true
              },
              {
                "title": "Branch",
                "value": "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME",
                "short": true
              },
              {
                "title": "Merge Request",
                "value": "<$CI_MERGE_REQUEST_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID|MR !$CI_MERGE_REQUEST_IID>",
                "short": true
              },
              {
                "title": "Author",
                "value": "$GITLAB_USER_NAME",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|$CI_COMMIT_SHORT_SHA>",
                "short": true
              },
              {
                "title": "Pipeline",
                "value": "<$CI_PIPELINE_URL|#$CI_PIPELINE_ID>",
                "short": true
              },
              {
                "title": "Failed Job",
                "value": "$CI_JOB_NAME",
                "short": false
              }
            ],
            "footer": "GitLab CI/CD",
            "ts": $(date +%s)
          }
        ]
      }
      EOF
      )
    
    # Send to Slack
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
          --data "$SLACK_MESSAGE" \
          "$SLACK_WEBHOOK_URL"
        echo "Failure notification sent to Slack"
      else
        echo "SLACK_WEBHOOK_URL not configured, skipping notification"
      fi
  when: on_failure

# MR comment with deployment results
mr-comment:
  stage: notify
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - job: health-check
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Posting comment to merge request"
    
    # Load deployment summary
    - source deployment-summary.env
    
    # Prepare MR comment
    - |
      MR_COMMENT=$(cat <<EOF
      ## Docker Swarm Deployment Results

      ### Security Scan
      Security scans completed successfully

      ### Stack Validation
      All stack files validated successfully

      ### Deployment Results
      - **Total stacks**: $TOTAL_STACKS
      - **Total services**: $TOTAL_SERVICES
      - **Running services**: $RUNNING_SERVICES

      ### Links
      - **Pipeline**: [#$CI_PIPELINE_ID]($CI_PIPELINE_URL)
      - **Commit**: [$CI_COMMIT_SHORT_SHA]($CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA)
      - **Author**: $GITLAB_USER_NAME

      ### Health Status
      All security scans passed  
      Stack validation completed  
      Docker Swarm initialized  
      Services deployed successfully  

      ---
      *Deployment completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
      EOF
      )
    
    # Post comment to MR
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        curl --request POST \
          --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          --header "Content-Type: application/json" \
          --data "{\"body\": $(echo "$MR_COMMENT" | jq -R -s .)}" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
        echo "Comment posted to merge request"
      else
        echo "GITLAB_TOKEN not configured, skipping MR comment"
      fi
  when: on_success
