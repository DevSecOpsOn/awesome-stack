# Fluent Bit configuration for Squid Proxy logs
# This configuration ships logs to Grafana Loki

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Path              /var/log/squid/access.log
    Tag               squid.access
    Parser            squid_access
    DB                /var/log/fluentbit-squid-access.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Path              /var/log/squid/cache.log
    Tag               squid.cache
    Parser            squid_cache
    DB                /var/log/fluentbit-squid-cache.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[FILTER]
    Name                kubernetes
    Match               squid.*
    Kube_Tag_Prefix     squid.
    Merge_Log           On
    Keep_Log            On

[FILTER]
    Name    modify
    Match   squid.*
    Add     service squid
    Add     component proxy
    Add     environment production

[OUTPUT]
    Name                loki
    Match               squid.*
    Host                loki
    Port                3100
    Labels              job=squid, service=squid, component=proxy
    Label_keys          $service,$component,$environment
    Line_format         json
    Auto_kubernetes_labels On

[OUTPUT]
    Name                stdout
    Match               squid.*
    Format              json_lines
